        <!DOCTYPE html>
        <html>
        <head>
                <meta charset="utf-8">
        <title>BasePersistentObject Class / persistent_object Library / Dart Documentation</title>
        <link rel="stylesheet" type="text/css"
            href="../styles.css">
        <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet" type="text/css">
        <link rel="shortcut icon" href="../favicon.ico">
        
        </head>
        <body data-library="persistent_object" data-type="BasePersistentObject">
        <div class="page">
        <div class="header">
          <a href="../index.html"><div class="logo"></div></a>
          <a href="../index.html">Dart Documentation</a>
         &rsaquo; <a href="../persistent_object.html">persistent_object</a> &rsaquo; <a href="../persistent_object/BasePersistentObject.html">BasePersistentObject</a>        <div id="search-box">
          <input type="search" name="q" id="q" autocomplete="off"
              class="search-input" placeholder="Search API">
        </div>
        
      </div>
      <div class="drop-down" id="drop-down"></div>
      
        <div class="nav">
        
<h2><div class="icon-library"></div><a href="../bson.html">bson</a></h2><h2><div class="icon-library"></div><a href="../bson_vm.html">bson_vm</a></h2><h2><div class="icon-library"></div><a href="../mongo.html">mongo</a></h2><h2><div class="icon-library"></div><a href="../objectory.html">objectory</a></h2><h2><div class="icon-library"></div><a href="../objectory_base.html">objectory_base</a></h2><h2><div class="icon-library"></div><a href="../objectory_direct_connection.html">objectory_direct_connection</a></h2><h2><div class="icon-library"></div><a href="../objectory_query.html">objectory_query</a></h2><h2><div class="icon-library"></div><a href="../persistent_object.html">persistent_object</a></h2><ul class="icon">
<li><div class="icon-class"></div><strong>BasePersistentObject</strong></li>
<li><a href="../persistent_object/EmbeddedPersistentObject.html"><div class="icon-class"></div>EmbeddedPersistentObject</a></li>
<li><a href="../persistent_object/PersistentIterator.html"><div class="icon-class"></div>PersistentIterator&lt;T&gt;</a></li>
<li><a href="../persistent_object/PersistentList.html"><div class="icon-class"></div>PersistentList&lt;T&gt;</a></li>
<li><a href="../persistent_object/PersistentObject.html"><div class="icon-interface"></div>PersistentObject</a></li>
<li><a href="../persistent_object/RootPersistentObject.html"><div class="icon-class"></div>RootPersistentObject</a></li>
</ul>
<h2><div class="icon-library"></div><a href="../persistent_schema.html">persistent_schema</a></h2></div>
<div class="content">
        <h2><strong>BasePersistentObject</strong>
          Class
        </h2>
        
<div class="doc">

</div>
<h3>Subclasses</h3>
<p>
<span class="type-box"><span class="icon-class"></span><a href="../persistent_object/EmbeddedPersistentObject.html">EmbeddedPersistentObject</a></span>, <span class="type-box"><span class="icon-class"></span><a href="../persistent_object/RootPersistentObject.html">RootPersistentObject</a></span></p>
<h3>Implements</h3>
<p>
<span class="type-box"><span class="icon-interface"></span><a href="../persistent_object/PersistentObject.html">PersistentObject</a></span></p>
<h3>Constructors</h3>
<div class="method"><h4 id="BasePersistentObject">
<span class="show-code">Code</span>
new <strong>BasePersistentObject</strong>() <a class="anchor-link" href="#BasePersistentObject"
              title="Permalink to BasePersistentObject.BasePersistentObject">#</a></h4>
<div class="doc">

<pre class="source">
BasePersistentObject() {
  map = new LinkedHashMap();
  _initMap();
  init();
  dirtyFields = new Set&lt;String&gt;();
}
</pre>
</div>
</div>
<h3>Methods</h3>
<div class="method"><h4 id="clearDirtyStatus">
<span class="show-code">Code</span>
void <strong>clearDirtyStatus</strong>() <a class="anchor-link" href="#clearDirtyStatus"
              title="Permalink to BasePersistentObject.clearDirtyStatus">#</a></h4>
<div class="doc">

<pre class="source">
void clearDirtyStatus() {
  dirtyFields.clear();
}
</pre>
</div>
</div>
<div class="method"><h4 id="fetchLink">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a>&lt;<a href="../persistent_object/PersistentObject.html">PersistentObject</a>&gt; <strong>fetchLink</strong>(<a href="http://api.dartlang.org/dart_core/String.html">String</a> property, [<a href="../persistent_schema/PropertySchema.html">PropertySchema</a> propertySchema, <a href="../bson/ObjectId.html">ObjectId</a> objectId]) <a class="anchor-link" href="#fetchLink"
              title="Permalink to BasePersistentObject.fetchLink">#</a></h4>
<div class="doc">

<pre class="source">
Future&lt;PersistentObject&gt; fetchLink(String property, [PropertySchema propertySchema, ObjectId objectId]) {
  var completer = new Completer&lt;PersistentObject&gt;();
  if (propertySchema === null) {
    propertySchema = objectory.getSchema(type).properties[property];
  }          
  if (propertySchema === null) {
    throw "Property $property is not registered on class $type";
  }
  if (!propertySchema.link &amp;&amp; !propertySchema.hasLinks){
    print(propertySchema);
    throw "Property $property is not of external ref type on class $type";
  }    
  var value;
  if (objectId !== null) {
    value = objectId;
  }    
  if (value === null) {
    value = map[property];
  }        
  if (value === null) {
    completer.complete(this);
  }
  else {      
    if (value is ObjectId){
      objectory.findOne(new ObjectoryQueryBuilder(propertySchema.type).id(value)).then((res){        
        completer.complete(this);
      });
    }     
    else {
      fetchRefsForListProperty(property,propertySchema,value).then((_)=&gt;completer.complete(this));         
    }
  }  
  return completer.future;
}
</pre>
</div>
</div>
<div class="method"><h4 id="fetchLinks">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a>&lt;<a href="../persistent_object/RootPersistentObject.html">RootPersistentObject</a>&gt; <strong>fetchLinks</strong>() <a class="anchor-link" href="#fetchLinks"
              title="Permalink to BasePersistentObject.fetchLinks">#</a></h4>
<div class="doc">

<pre class="source">
Future&lt;RootPersistentObject&gt; fetchLinks(){
  var futures = new List();
  for (var propertySchema in objectory.getSchema(type).properties.getValues()) {
    if (propertySchema.link || propertySchema.hasLinks) {
      futures.add(fetchLink(propertySchema.name, propertySchema));
    }          
  }
  Completer completer = new Completer&lt;PersistentObject&gt;();
  Futures.wait(futures).then((_) =&gt; completer.complete(this));
  return completer.future;    
}
</pre>
</div>
</div>
<div class="method"><h4 id="fetchRefsForListProperty">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a> <strong>fetchRefsForListProperty</strong>(<a href="http://api.dartlang.org/dart_core/String.html">String</a> property, <a href="../persistent_schema/PropertySchema.html">PropertySchema</a> propertySchema, list) <a class="anchor-link" href="#fetchRefsForListProperty"
              title="Permalink to BasePersistentObject.fetchRefsForListProperty">#</a></h4>
<div class="doc">

<pre class="source">
Future fetchRefsForListProperty(String property, PropertySchema propertySchema, list) {  
  var futures = new List&lt;Future&gt;();
  if (propertySchema.embeddedObject) {  
    for (var each in new PersistentList(list, parent:this, pathToMe: property)) {
      futures.add(each.fetchLinks());
    }  
  }
  else {    
    for (var each in list) {
      futures.add(fetchLink(property,propertySchema,each));
    } 
  }   
  return Futures.wait(futures);
}
</pre>
</div>
</div>
<div class="method"><h4 id="getProperty">
<span class="show-code">Code</span>
<strong>getProperty</strong>(<a href="http://api.dartlang.org/dart_core/String.html">String</a> property) <a class="anchor-link" href="#getProperty"
              title="Permalink to BasePersistentObject.getProperty">#</a></h4>
<div class="doc">

<pre class="source">
Dynamic getProperty(String property){
  return noSuchMethod('get:$property',[]);
}
</pre>
</div>
</div>
<div class="method"><h4 id="init">
<span class="show-code">Code</span>
void <strong>init</strong>() <a class="anchor-link" href="#init"
              title="Permalink to BasePersistentObject.init">#</a></h4>
<div class="doc">

<pre class="source">
void init(){}
</pre>
</div>
</div>
<div class="method"><h4 id="isDirty">
<span class="show-code">Code</span>
<strong>isDirty</strong>() <a class="anchor-link" href="#isDirty"
              title="Permalink to BasePersistentObject.isDirty">#</a></h4>
<div class="doc">

<pre class="source">
isDirty() {
  return !dirtyFields.isEmpty();
}
</pre>
</div>
</div>
<div class="method"><h4 id="noSuchMethod">
<span class="show-code">Code</span>
<strong>noSuchMethod</strong>(<a href="http://api.dartlang.org/dart_core/String.html">String</a> function_name, <a href="http://api.dartlang.org/dart_core/List.html">List</a> args) <a class="anchor-link" href="#noSuchMethod"
              title="Permalink to BasePersistentObject.noSuchMethod">#</a></h4>
<div class="doc">

<pre class="source">
noSuchMethod(String function_name, List args) {
  ClassSchema schema = objectory.getSchema(type);
  if (schema === null){
    throw "Class $type have not been registered in Objectory";
  }
  PropertySchema propertySchema;
  if (args.length == 0 &amp;&amp; function_name.startsWith("get:")) {
    //synthetic getter
    var property = function_name.replaceFirst("get:", "");
    propertySchema = schema.properties[property];
    if (propertySchema === null) {
      super.noSuchMethod(function_name, args);
    }      
    final value = this.map[property];      
    if (propertySchema.collection) {
      return new PersistentList(value, parent: this, pathToMe: property);
    }
    if (propertySchema.embeddedObject) {
      EmbeddedPersistentObject result =  objectory.map2Object(propertySchema.type, value);
      result.parent = this;
      result.pathToMe = property;
      return result;
    }
    if (propertySchema.link)  {      
      if (value === null) {
        return null;
      }
      else {
        var result = objectory.findInCache(value);
        if (result === null) {
          throw "External ref ${propertySchema.name} has not been fetched yet";
        }
        return result;
      }
    }
    return value;
  }
  else if (args.length == 1 &amp;&amp; function_name.startsWith("set:")) {
    //synthetic setter
    var value = args[0];
    var property = function_name.replaceFirst("set:", "");
    propertySchema = schema.properties[property];
    if (propertySchema !== null) {
      if (propertySchema.link &amp;&amp; !propertySchema.collection &amp;&amp; value is RootPersistentObject){
        if (value !== null) {            
          if (value.id === null){        
            throw "Error setting link property $property. Link object must have not null id";
          }
          value = value.id;             
        }          
      }
      if (value is BasePersistentObject) {
        value = value.map;
      }
      if (value is PersistentList) {
        value = value.internalList;
      }        
      onValueChanging(property, value);
      this.map[property] = value;
      return;
    }
    else {       
      print("Not registered property $property on for class $type");
      print(schema.properties);
      super.noSuchMethod(function_name, args);
    }        
  }    
  //if we get here, then we've not found it - throw.
  super.noSuchMethod(function_name, args);
}
</pre>
</div>
</div>
<div class="method"><h4 id="onValueChanging">
<span class="show-code">Code</span>
void <strong>onValueChanging</strong>(<a href="http://api.dartlang.org/dart_core/String.html">String</a> fieldName, newValue) <a class="anchor-link" href="#onValueChanging"
              title="Permalink to BasePersistentObject.onValueChanging">#</a></h4>
<div class="doc">

<pre class="source">
void onValueChanging(String fieldName, newValue) {
  setDirty(fieldName);
}
</pre>
</div>
</div>
<div class="method"><h4 id="setDirty">
<span class="show-code">Code</span>
void <strong>setDirty</strong>(<a href="http://api.dartlang.org/dart_core/String.html">String</a> fieldName) <a class="anchor-link" href="#setDirty"
              title="Permalink to BasePersistentObject.setDirty">#</a></h4>
<div class="doc">

<pre class="source">
void setDirty(String fieldName) {
  if (dirtyFields === null){
    return;
  }
  dirtyFields.add(fieldName);
}
</pre>
</div>
</div>
<div class="method"><h4 id="setProperty">
<span class="show-code">Code</span>
void <strong>setProperty</strong>(<a href="http://api.dartlang.org/dart_core/String.html">String</a> property, value) <a class="anchor-link" href="#setProperty"
              title="Permalink to BasePersistentObject.setProperty">#</a></h4>
<div class="doc">

<pre class="source">
void setProperty(String property, value){
  noSuchMethod('set:$property',[value]);
}
</pre>
</div>
</div>
<div class="method"><h4 id="toString">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/String.html">String</a> <strong>toString</strong>() <a class="anchor-link" href="#toString"
              title="Permalink to BasePersistentObject.toString">#</a></h4>
<div class="doc">

<pre class="source">
String toString()=&gt;"$type($map)";
</pre>
</div>
</div>
<div class="method"><h4 id="type">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/String.html">String</a> <strong>get type</strong>() <a class="anchor-link" href="#type"
              title="Permalink to BasePersistentObject.get type">#</a></h4>
<div class="doc">

<pre class="source">
String get type =&gt; "PersistentObjectBase";
</pre>
</div>
</div>
<h3>Fields</h3>
<div class="field"><h4 id="dirtyFields">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Set.html">Set</a>&lt;<a href="http://api.dartlang.org/dart_core/String.html">String</a>&gt;         <strong>dirtyFields</strong> <a class="anchor-link"
            href="#dirtyFields"
            title="Permalink to BasePersistentObject.dirtyFields">#</a>
        </h4>
        <div class="doc">

<pre class="source">
Set&lt;String&gt; dirtyFields;
</pre>
</div>
</div>
<div class="field"><h4 id="map">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/LinkedHashMap.html">LinkedHashMap</a>         <strong>map</strong> <a class="anchor-link"
            href="#map"
            title="Permalink to BasePersistentObject.map">#</a>
        </h4>
        <div class="doc">

<pre class="source">
LinkedHashMap map;
</pre>
</div>
</div>
<div class="field"><h4 id="setupMode">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/bool.html">bool</a>         <strong>setupMode</strong> <a class="anchor-link"
            href="#setupMode"
            title="Permalink to BasePersistentObject.setupMode">#</a>
        </h4>
        <div class="doc">

<pre class="source">
bool setupMode;
</pre>
</div>
</div>
        </div>
        <div class="clear"></div>
        </div>
        
        <div class="footer">
          <div>This page was generated at 2012-09-12 16:03:43.367</div>
        </div>
        <script async src="../client-static.js"></script>
        </body></html>
        
