        <!DOCTYPE html>
        <html>
        <head>
                <meta charset="utf-8">
        <title>Cursor Class / mongo Library / Dart Documentation</title>
        <link rel="stylesheet" type="text/css"
            href="../styles.css">
        <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet" type="text/css">
        <link rel="shortcut icon" href="../favicon.ico">
        
        </head>
        <body data-library="mongo" data-type="Cursor">
        <div class="page">
        <div class="header">
          <a href="../index.html"><div class="logo"></div></a>
          <a href="../index.html">Dart Documentation</a>
         &rsaquo; <a href="../mongo.html">mongo</a> &rsaquo; <a href="../mongo/Cursor.html">Cursor</a>        <div id="search-box">
          <input type="search" name="q" id="q" autocomplete="off"
              class="search-input" placeholder="Search API">
        </div>
        
      </div>
      <div class="drop-down" id="drop-down"></div>
      
        <div class="nav">
        
<h2><div class="icon-library"></div><a href="../bson.html">bson</a></h2><h2><div class="icon-library"></div><a href="../bson_vm.html">bson_vm</a></h2><h2><div class="icon-library"></div><a href="../mongo.html">mongo</a></h2><ul class="icon">
<li><a href="../mongo/Connection.html"><div class="icon-class"></div>Connection</a></li>
<li><div class="icon-class"></div><strong>Cursor</strong></li>
<li><a href="../mongo/Db.html"><div class="icon-class"></div>Db</a></li>
<li><a href="../mongo/DbCollection.html"><div class="icon-class"></div>DbCollection</a></li>
<li><a href="../mongo/DbCommand.html"><div class="icon-class"></div>DbCommand</a></li>
<li><a href="../mongo/MapProxy.html"><div class="icon-class"></div>MapProxy&lt;K, V&gt;</a></li>
<li><a href="../mongo/MonadicBlock.html"><div class="icon-interface"></div>MonadicBlock</a></li>
<li><a href="../mongo/MongoGetMoreMessage.html"><div class="icon-class"></div>MongoGetMoreMessage</a></li>
<li><a href="../mongo/MongoInsertMessage.html"><div class="icon-class"></div>MongoInsertMessage</a></li>
<li><a href="../mongo/MongoKillCursorsMessage.html"><div class="icon-class"></div>MongoKillCursorsMessage</a></li>
<li><a href="../mongo/MongoMessage.html"><div class="icon-class"></div>MongoMessage</a></li>
<li><a href="../mongo/MongoQueryMessage.html"><div class="icon-class"></div>MongoQueryMessage</a></li>
<li><a href="../mongo/MongoRemoveMessage.html"><div class="icon-class"></div>MongoRemoveMessage</a></li>
<li><a href="../mongo/MongoReplyMessage.html"><div class="icon-class"></div>MongoReplyMessage</a></li>
<li><a href="../mongo/MongoUpdateMessage.html"><div class="icon-class"></div>MongoUpdateMessage</a></li>
<li><a href="../mongo/SelectorBuilder.html"><div class="icon-class"></div>SelectorBuilder&lt;K, V&gt;</a></li>
<li><a href="../mongo/ServerConfig.html"><div class="icon-class"></div>ServerConfig</a></li>
<li><a href="../mongo/Utils.html"><div class="icon-class"></div>Utils</a></li>
</ul>
<h2><div class="icon-library"></div><a href="../objectory.html">objectory</a></h2><h2><div class="icon-library"></div><a href="../objectory_base.html">objectory_base</a></h2><h2><div class="icon-library"></div><a href="../objectory_direct_connection.html">objectory_direct_connection</a></h2><h2><div class="icon-library"></div><a href="../objectory_query.html">objectory_query</a></h2><h2><div class="icon-library"></div><a href="../persistent_object.html">persistent_object</a></h2><h2><div class="icon-library"></div><a href="../persistent_schema.html">persistent_schema</a></h2></div>
<div class="content">
        <h2><strong>Cursor</strong>
          Class
        </h2>
        
<div class="doc">

</div>
<h3>Constructors</h3>
<div class="method"><h4 id="Cursor">
<span class="show-code">Code</span>
new <strong>Cursor</strong>(<a href="../mongo/Db.html">Db</a> db, <a href="../mongo/DbCollection.html">DbCollection</a> collection, [<a href="http://api.dartlang.org/dart_core/Map.html">Map</a> selector, <a href="http://api.dartlang.org/dart_core/Map.html">Map</a> fields, <a href="http://api.dartlang.org/dart_core/int.html">int</a> skip = 0, <a href="http://api.dartlang.org/dart_core/int.html">int</a> limit = 0, <a href="http://api.dartlang.org/dart_core/Map.html">Map</a> sort, <a href="http://api.dartlang.org/dart_core/Map.html">Map</a> hint, <a href="http://api.dartlang.org/dart_core/bool.html">bool</a> explain]) <a class="anchor-link" href="#Cursor"
              title="Permalink to Cursor.Cursor">#</a></h4>
<div class="doc">

<pre class="source">
Cursor(this.db, this.collection, [this.selector, this.fields, this.skip=0, this.limit=0
, this.sort, this.hint, this.explain]){
  if (selector === null){
    selector = {};
  } else{
    if (!selector.containsKey("query")){
      selector = {"query": selector};
    }          
  }
  if (sort !== null){
    selector["orderby"] = sort;
  }
  items = new Queue();
}
</pre>
</div>
</div>
<h3>Static Fields</h3>
<div class="field"><h4 id="CLOSED">
<span class="show-code">Code</span>
final         <strong>CLOSED</strong> <a class="anchor-link"
            href="#CLOSED"
            title="Permalink to Cursor.CLOSED">#</a>
        </h4>
        <div class="doc">
<p>Cursor closed</p>
<p>@classconstant CLOSED</p>
<pre class="source">
static final CLOSED = 2;
</pre>
</div>
</div>
<div class="field"><h4 id="INIT">
<span class="show-code">Code</span>
final         <strong>INIT</strong> <a class="anchor-link"
            href="#INIT"
            title="Permalink to Cursor.INIT">#</a>
        </h4>
        <div class="doc">
<p>Init state</p>
<p>@classconstant INIT</p>
<pre class="source">
static final INIT = 0;
</pre>
</div>
</div>
<div class="field"><h4 id="OPEN">
<span class="show-code">Code</span>
final         <strong>OPEN</strong> <a class="anchor-link"
            href="#OPEN"
            title="Permalink to Cursor.OPEN">#</a>
        </h4>
        <div class="doc">
<p>Cursor open</p>
<p>@classconstant OPEN</p>
<pre class="source">
static final OPEN = 1;
</pre>
</div>
</div>
<h3>Methods</h3>
<div class="method"><h4 id="close">
<span class="show-code">Code</span>
void <strong>close</strong>() <a class="anchor-link" href="#close"
              title="Permalink to Cursor.close">#</a></h4>
<div class="doc">

<pre class="source">
void close(){
  debug("Closing cursor, cursorId = $cursorId");
  if (cursorId != 0){      
    MongoKillCursorsMessage msg = new MongoKillCursorsMessage(cursorId);
    db.executeMessage(msg);
    cursorId = 0;
  } 
  state = CLOSED;
}
</pre>
</div>
</div>
<div class="method"><h4 id="each">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/bool.html">bool</a>&gt; <strong>each</strong>(<a href="../mongo/MonadicBlock.html">MonadicBlock</a> callback) <a class="anchor-link" href="#each"
              title="Permalink to Cursor.each">#</a></h4>
<div class="doc">

<pre class="source">
Future&lt;bool&gt; each(MonadicBlock callback){
  eachCallback = callback; 
  eachComplete = new Completer();
  nextEach();
  return eachComplete.future;
}
</pre>
</div>
</div>
<div class="method"><h4 id="generateGetMoreMessage">
<span class="show-code">Code</span>
<a href="../mongo/MongoGetMoreMessage.html">MongoGetMoreMessage</a> <strong>generateGetMoreMessage</strong>() <a class="anchor-link" href="#generateGetMoreMessage"
              title="Permalink to Cursor.generateGetMoreMessage">#</a></h4>
<div class="doc">

<pre class="source">
MongoGetMoreMessage generateGetMoreMessage(){
  return new  MongoGetMoreMessage(collection.fullName(),
          cursorId);
}
</pre>
</div>
</div>
<div class="method"><h4 id="generateQueryMessage">
<span class="show-code">Code</span>
<a href="../mongo/MongoQueryMessage.html">MongoQueryMessage</a> <strong>generateQueryMessage</strong>() <a class="anchor-link" href="#generateQueryMessage"
              title="Permalink to Cursor.generateQueryMessage">#</a></h4>
<div class="doc">

<pre class="source">
MongoQueryMessage generateQueryMessage(){
  return new  MongoQueryMessage(collection.fullName(),
          flags,
          skip,
          limit,
          selector,
          fields);
}
</pre>
</div>
</div>
<div class="method"><h4 id="getNextItem">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Map.html">Map</a> <strong>getNextItem</strong>() <a class="anchor-link" href="#getNextItem"
              title="Permalink to Cursor.getNextItem">#</a></h4>
<div class="doc">

<pre class="source">
Map getNextItem(){
  return items.removeFirst();
}
</pre>
</div>
</div>
<div class="method"><h4 id="nextEach">
<span class="show-code">Code</span>
void <strong>nextEach</strong>() <a class="anchor-link" href="#nextEach"
              title="Permalink to Cursor.nextEach">#</a></h4>
<div class="doc">

<pre class="source">
void nextEach(){
  nextObject().then((val){
    if (val === null){
      eachCallback = null;
      eachComplete.complete(true);
    } else {
      eachCallback(val);
      nextEach();
    }            
  });
}
</pre>
</div>
</div>
<div class="method"><h4 id="nextObject">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/Map.html">Map</a>&gt; <strong>nextObject</strong>() <a class="anchor-link" href="#nextObject"
              title="Permalink to Cursor.nextObject">#</a></h4>
<div class="doc">

<pre class="source">
Future&lt;Map&gt; nextObject(){
  if (state == INIT){
    Completer&lt;Map&gt; nextItem = new Completer&lt;Map&gt;();
    MongoQueryMessage qm = generateQueryMessage();
    Future&lt;MongoReplyMessage&gt; reply = db.executeQueryMessage(qm);
    reply.then((replyMessage){
      state = OPEN;
      //print("${replyMessage.cursorId}");
      cursorId = replyMessage.cursorId;
      items.addAll(replyMessage.documents);
      if (items.length &gt; 0){
        Map nextDoc = getNextItem();
        debug("Cursor getNextItem $nextDoc");
        nextItem.complete(nextDoc);
      }
      else{
        nextItem.complete(null);
      }
    });
    return nextItem.future;
  }  
  else if (state == OPEN &amp;&amp; items.length &gt; 0){
    return new Future.immediate(getNextItem());
  }
  else if (state == OPEN &amp;&amp; cursorId &gt; 0){
    Completer nextItem = new Completer();
    var qm = generateGetMoreMessage();
    Future&lt;MongoReplyMessage&gt; reply = db.executeQueryMessage(qm);
    reply.then((replyMessage){
      state = OPEN;
      cursorId = replyMessage.cursorId;
      items.addAll(replyMessage.documents);
      if (items.length &gt; 0){
        nextItem.complete(getNextItem());
      }
      else{
        state = CLOSED;          
        nextItem.complete(null);
      }
    });
    return nextItem.future;
  }    
  else {
    state = CLOSED;
    return new Future.immediate(null);
  }
}
</pre>
</div>
</div>
<div class="method"><h4 id="toList">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/List.html">List</a>&lt;<a href="http://api.dartlang.org/dart_core/Map.html">Map</a>&gt;&gt; <strong>toList</strong>() <a class="anchor-link" href="#toList"
              title="Permalink to Cursor.toList">#</a></h4>
<div class="doc">

<pre class="source">
Future&lt;List&lt;Map&gt;&gt; toList(){
  List&lt;Map&gt; result = [];
  Completer completer = new Completer();
  this.each((v)=&gt;result.addLast(v)).then((v)=&gt;completer.complete(result));
  return completer.future;    
}
</pre>
</div>
</div>
<h3>Fields</h3>
<div class="field"><h4 id="collection">
<span class="show-code">Code</span>
<a href="../mongo/DbCollection.html">DbCollection</a>         <strong>collection</strong> <a class="anchor-link"
            href="#collection"
            title="Permalink to Cursor.collection">#</a>
        </h4>
        <div class="doc">

<pre class="source">
DbCollection collection;
</pre>
</div>
</div>
<div class="field"><h4 id="cursorId">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/int.html">int</a>         <strong>cursorId</strong> <a class="anchor-link"
            href="#cursorId"
            title="Permalink to Cursor.cursorId">#</a>
        </h4>
        <div class="doc">

<pre class="source">
int cursorId = 0;
</pre>
</div>
</div>
<div class="field"><h4 id="db">
<span class="show-code">Code</span>
<a href="../mongo/Db.html">Db</a>         <strong>db</strong> <a class="anchor-link"
            href="#db"
            title="Permalink to Cursor.db">#</a>
        </h4>
        <div class="doc">

<pre class="source">
Db db;
</pre>
</div>
</div>
<div class="field"><h4 id="eachCallback">
<span class="show-code">Code</span>
<a href="../mongo/MonadicBlock.html">MonadicBlock</a>         <strong>eachCallback</strong> <a class="anchor-link"
            href="#eachCallback"
            title="Permalink to Cursor.eachCallback">#</a>
        </h4>
        <div class="doc">

<pre class="source">
MonadicBlock eachCallback;
</pre>
</div>
</div>
<div class="field"><h4 id="eachComplete">
<span class="show-code">Code</span>
var         <strong>eachComplete</strong> <a class="anchor-link"
            href="#eachComplete"
            title="Permalink to Cursor.eachComplete">#</a>
        </h4>
        <div class="doc">

<pre class="source">
var eachComplete;
</pre>
</div>
</div>
<div class="field"><h4 id="explain">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/bool.html">bool</a>         <strong>explain</strong> <a class="anchor-link"
            href="#explain"
            title="Permalink to Cursor.explain">#</a>
        </h4>
        <div class="doc">

<pre class="source">
bool explain;
</pre>
</div>
</div>
<div class="field"><h4 id="fields">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Map.html">Map</a>         <strong>fields</strong> <a class="anchor-link"
            href="#fields"
            title="Permalink to Cursor.fields">#</a>
        </h4>
        <div class="doc">

<pre class="source">
Map fields;
</pre>
</div>
</div>
<div class="field"><h4 id="flags">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/int.html">int</a>         <strong>flags</strong> <a class="anchor-link"
            href="#flags"
            title="Permalink to Cursor.flags">#</a>
        </h4>
        <div class="doc">

<pre class="source">
int flags = 0;
</pre>
</div>
</div>
<div class="field"><h4 id="hint">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Map.html">Map</a>         <strong>hint</strong> <a class="anchor-link"
            href="#hint"
            title="Permalink to Cursor.hint">#</a>
        </h4>
        <div class="doc">

<pre class="source">
Map hint;
</pre>
</div>
</div>
<div class="field"><h4 id="items">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Queue.html">Queue</a>         <strong>items</strong> <a class="anchor-link"
            href="#items"
            title="Permalink to Cursor.items">#</a>
        </h4>
        <div class="doc">

<pre class="source">
Queue items;
</pre>
</div>
</div>
<div class="field"><h4 id="limit">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/int.html">int</a>         <strong>limit</strong> <a class="anchor-link"
            href="#limit"
            title="Permalink to Cursor.limit">#</a>
        </h4>
        <div class="doc">

<pre class="source">
int limit;
</pre>
</div>
</div>
<div class="field"><h4 id="selector">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Map.html">Map</a>         <strong>selector</strong> <a class="anchor-link"
            href="#selector"
            title="Permalink to Cursor.selector">#</a>
        </h4>
        <div class="doc">

<pre class="source">
Map selector;
</pre>
</div>
</div>
<div class="field"><h4 id="skip">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/int.html">int</a>         <strong>skip</strong> <a class="anchor-link"
            href="#skip"
            title="Permalink to Cursor.skip">#</a>
        </h4>
        <div class="doc">

<pre class="source">
int skip;
</pre>
</div>
</div>
<div class="field"><h4 id="sort">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Map.html">Map</a>         <strong>sort</strong> <a class="anchor-link"
            href="#sort"
            title="Permalink to Cursor.sort">#</a>
        </h4>
        <div class="doc">

<pre class="source">
Map sort;
</pre>
</div>
</div>
<div class="field"><h4 id="state">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/int.html">int</a>         <strong>state</strong> <a class="anchor-link"
            href="#state"
            title="Permalink to Cursor.state">#</a>
        </h4>
        <div class="doc">

<pre class="source">
int state = INIT;
</pre>
</div>
</div>
        </div>
        <div class="clear"></div>
        </div>
        
        <div class="footer">
          <div>This page was generated at 2012-09-12 16:03:43.214</div>
        </div>
        <script async src="../client-static.js"></script>
        </body></html>
        
