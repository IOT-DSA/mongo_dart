        <!DOCTYPE html>
        <html>
        <head>
                <meta charset="utf-8">
        <title>Db Class / mongo Library / Dart Documentation</title>
        <link rel="stylesheet" type="text/css"
            href="../styles.css">
        <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet" type="text/css">
        <link rel="shortcut icon" href="../favicon.ico">
        
        </head>
        <body data-library="mongo" data-type="Db">
        <div class="page">
        <div class="header">
          <a href="../index.html"><div class="logo"></div></a>
          <a href="../index.html">Dart Documentation</a>
         &rsaquo; <a href="../mongo.html">mongo</a> &rsaquo; <a href="../mongo/Db.html">Db</a>        <div id="search-box">
          <input type="search" name="q" id="q" autocomplete="off"
              class="search-input" placeholder="Search API">
        </div>
        
      </div>
      <div class="drop-down" id="drop-down"></div>
      
        <div class="nav">
        
<h2><div class="icon-library"></div><a href="../bson.html">bson</a></h2><h2><div class="icon-library"></div><a href="../bson_vm.html">bson_vm</a></h2><h2><div class="icon-library"></div><a href="../mongo.html">mongo</a></h2><ul class="icon">
<li><a href="../mongo/Connection.html"><div class="icon-class"></div>Connection</a></li>
<li><a href="../mongo/Cursor.html"><div class="icon-class"></div>Cursor</a></li>
<li><div class="icon-class"></div><strong>Db</strong></li>
<li><a href="../mongo/DbCollection.html"><div class="icon-class"></div>DbCollection</a></li>
<li><a href="../mongo/DbCommand.html"><div class="icon-class"></div>DbCommand</a></li>
<li><a href="../mongo/MapProxy.html"><div class="icon-class"></div>MapProxy&lt;K, V&gt;</a></li>
<li><a href="../mongo/MonadicBlock.html"><div class="icon-interface"></div>MonadicBlock</a></li>
<li><a href="../mongo/MongoGetMoreMessage.html"><div class="icon-class"></div>MongoGetMoreMessage</a></li>
<li><a href="../mongo/MongoInsertMessage.html"><div class="icon-class"></div>MongoInsertMessage</a></li>
<li><a href="../mongo/MongoKillCursorsMessage.html"><div class="icon-class"></div>MongoKillCursorsMessage</a></li>
<li><a href="../mongo/MongoMessage.html"><div class="icon-class"></div>MongoMessage</a></li>
<li><a href="../mongo/MongoQueryMessage.html"><div class="icon-class"></div>MongoQueryMessage</a></li>
<li><a href="../mongo/MongoRemoveMessage.html"><div class="icon-class"></div>MongoRemoveMessage</a></li>
<li><a href="../mongo/MongoReplyMessage.html"><div class="icon-class"></div>MongoReplyMessage</a></li>
<li><a href="../mongo/MongoUpdateMessage.html"><div class="icon-class"></div>MongoUpdateMessage</a></li>
<li><a href="../mongo/SelectorBuilder.html"><div class="icon-class"></div>SelectorBuilder&lt;K, V&gt;</a></li>
<li><a href="../mongo/ServerConfig.html"><div class="icon-class"></div>ServerConfig</a></li>
<li><a href="../mongo/Utils.html"><div class="icon-class"></div>Utils</a></li>
</ul>
<h2><div class="icon-library"></div><a href="../objectory.html">objectory</a></h2><h2><div class="icon-library"></div><a href="../objectory_base.html">objectory_base</a></h2><h2><div class="icon-library"></div><a href="../objectory_direct_connection.html">objectory_direct_connection</a></h2><h2><div class="icon-library"></div><a href="../objectory_query.html">objectory_query</a></h2><h2><div class="icon-library"></div><a href="../persistent_object.html">persistent_object</a></h2><h2><div class="icon-library"></div><a href="../persistent_schema.html">persistent_schema</a></h2></div>
<div class="content">
        <h2><strong>Db</strong>
          Class
        </h2>
        
<div class="doc">

</div>
<h3>Constructors</h3>
<div class="method"><h4 id="Db">
<span class="show-code">Code</span>
new <strong>Db</strong>(<a href="http://api.dartlang.org/dart_core/String.html">String</a> uriString) <a class="anchor-link" href="#Db"
              title="Permalink to Db.Db">#</a></h4>
<div class="doc">
<p>Db constructor expects <a href="http://www.mongodb.org/display/DOCS/Connections">valid mongodb URI</a>.
For example next code points to local mongodb server on default mongodb port, database <em>testdb</em></p>
<pre><code>var db = new Db('mongodb://127.0.0.1/testdb');
</code></pre>
<p>And that code direct to MongoLab server on 37637 port, database <em>testdb</em>, username <em>dart</em>, password <em>test</em></p>
<pre><code>var db = new Db('mongodb://dart:test@ds037637-a.mongolab.com:37637/objectory_blog');
</code></pre>
<pre class="source">
Db(String uriString){
  var uri = new Uri.fromString(uriString);
  if (uri.scheme != 'mongodb') {
    throw 'Invalid scheme in uri: $uriString ${uri.scheme}';
  }
  serverConfig = new ServerConfig();
  serverConfig.host = uri.domain;
  serverConfig.port = uri.port;
  if (serverConfig.port == null || serverConfig.port == 0){
    serverConfig.port = 27017;
  }
  if (uri.userInfo != '') {
    var userInfo = uri.userInfo.split(':');
    if (userInfo.length != 2) {
      throw 'Неверный формат поля userInfo: $uri.userInfo';
    }
    serverConfig.userName = userInfo[0];
    serverConfig.password = userInfo[1];
  }
  if (uri.path != '') {
    databaseName = uri.path.replaceAll('/','');
  }
  connection = new Connection(serverConfig);
}
</pre>
</div>
</div>
<div class="method"><h4 id="Db.local">
<span class="show-code">Code</span>
new <strong>Db</strong>.local(<a href="http://api.dartlang.org/dart_core/String.html">String</a> databaseName) <a class="anchor-link" href="#Db.local"
              title="Permalink to Db.Db">#</a></h4>
<div class="doc">

<pre class="source">
Db.local(this.databaseName){
   if (serverConfig === null) {
    serverConfig = new ServerConfig();
   }
  connection = new Connection(serverConfig);
}
</pre>
</div>
</div>
<h3>Methods</h3>
<div class="method"><h4 id="authenticate">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/bool.html">bool</a>&gt; <strong>authenticate</strong>(<a href="http://api.dartlang.org/dart_core/String.html">String</a> userName, <a href="http://api.dartlang.org/dart_core/String.html">String</a> password) <a class="anchor-link" href="#authenticate"
              title="Permalink to Db.authenticate">#</a></h4>
<div class="doc">

<pre class="source">
Future&lt;bool&gt; authenticate(String userName, String password){
  Completer completer = new Completer();
  getNonce().chain((msg) {
    var nonce = msg["nonce"];
    var command = DbCommand.createAuthenticationCommand(this,userName,password,nonce);
    serverConfig.password = '***********';
    return executeDbCommand(command);
  }).
  then((res)=&gt;completer.complete(res["ok"] == 1));
  return completer.future;
}
</pre>
</div>
</div>
<div class="method"><h4 id="close">
<span class="show-code">Code</span>
void <strong>close</strong>() <a class="anchor-link" href="#close"
              title="Permalink to Db.close">#</a></h4>
<div class="doc">

<pre class="source">
void close(){
//    print("closing db");
  connection.close();
}
</pre>
</div>
</div>
<div class="method"><h4 id="collection">
<span class="show-code">Code</span>
<a href="../mongo/DbCollection.html">DbCollection</a> <strong>collection</strong>(<a href="http://api.dartlang.org/dart_core/String.html">String</a> collectionName) <a class="anchor-link" href="#collection"
              title="Permalink to Db.collection">#</a></h4>
<div class="doc">

<pre class="source">
DbCollection collection(String collectionName){
    return new DbCollection(this,collectionName);
}
</pre>
</div>
</div>
<div class="method"><h4 id="collectionsInfoCursor">
<span class="show-code">Code</span>
<a href="../mongo/Cursor.html">Cursor</a> <strong>collectionsInfoCursor</strong>([<a href="http://api.dartlang.org/dart_core/String.html">String</a> collectionName]) <a class="anchor-link" href="#collectionsInfoCursor"
              title="Permalink to Db.collectionsInfoCursor">#</a></h4>
<div class="doc">

<pre class="source">
Cursor collectionsInfoCursor([String collectionName]) {
  Map selector = {};
  // If we are limiting the access to a specific collection name
  if(collectionName !== null){
    selector["name"] = "${this.databaseName}.$collectionName";
  }  
  // Return Cursor
    return new Cursor(this, new DbCollection(this, DbCommand.SYSTEM_NAMESPACE_COLLECTION), selector);      
}
</pre>
</div>
</div>
<div class="method"><h4 id="drop">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/Map.html">Map</a>&gt; <strong>drop</strong>() <a class="anchor-link" href="#drop"
              title="Permalink to Db.drop">#</a></h4>
<div class="doc">
<p>  Drop current database</p>
<pre class="source">
Future&lt;Map&gt; drop(){
  Completer completer = new Completer();
  executeDbCommand(DbCommand.createDropDatabaseCommand(this))
    .then((res)=&gt;completer.complete(res));
  return completer.future;    
}
</pre>
</div>
</div>
<div class="method"><h4 id="dropCollection">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/bool.html">bool</a>&gt; <strong>dropCollection</strong>(<a href="http://api.dartlang.org/dart_core/String.html">String</a> collectionName) <a class="anchor-link" href="#dropCollection"
              title="Permalink to Db.dropCollection">#</a></h4>
<div class="doc">

<pre class="source">
Future&lt;bool&gt; dropCollection(String collectionName){
  Completer completer = new Completer();
  collectionsInfoCursor(collectionName).toList().then((v){
    if (v.length == 1){
      executeDbCommand(DbCommand.createDropCollectionCommand(this,collectionName))
        .then((res)=&gt;completer.complete(res));
      } else{
        completer.complete(true);
      }  
  });    
  return completer.future;    
}
</pre>
</div>
</div>
<div class="method"><h4 id="executeDbCommand">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/Map.html">Map</a>&gt; <strong>executeDbCommand</strong>(<a href="../mongo/MongoMessage.html">MongoMessage</a> message) <a class="anchor-link" href="#executeDbCommand"
              title="Permalink to Db.executeDbCommand">#</a></h4>
<div class="doc">

<pre class="source">
Future&lt;Map&gt; executeDbCommand(MongoMessage message){
    Completer&lt;Map&gt; result = new Completer();
    //print("executeDbCommand.message = ${message}");
    connection.query(message).then((replyMessage){
      //print("replyMessage = ${replyMessage}");
      //print("replyMessage.documents = ${replyMessage.documents}");
      
      String errMsg;
      if (replyMessage.documents.length == 0) {
        errMsg = "Error executing Db command, Document length 0 $replyMessage";
        print("Error: $errMsg");
        var m = new Map();
        m["errmsg"]=errMsg;
        result.complete(m);
      } else  if (replyMessage.documents[0]["ok"] == 1.0){
        result.complete(replyMessage.documents[0]);
      } else {
        errMsg = "Error executing Db command";
        if (replyMessage.documents[0].containsKey("errmsg")){
          errMsg = replyMessage.documents[0]["errmsg"];
        }
        print("Error: $errMsg");
        result.complete(replyMessage.documents[0]);
      }         
    });
  return result.future;        
}
</pre>
</div>
</div>
<div class="method"><h4 id="executeMessage">
<span class="show-code">Code</span>
<strong>executeMessage</strong>(<a href="../mongo/MongoMessage.html">MongoMessage</a> message) <a class="anchor-link" href="#executeMessage"
              title="Permalink to Db.executeMessage">#</a></h4>
<div class="doc">

<pre class="source">
executeMessage(MongoMessage message){
  connection.execute(message);
}
</pre>
</div>
</div>
<div class="method"><h4 id="executeQueryMessage">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a>&lt;<a href="../mongo/MongoReplyMessage.html">MongoReplyMessage</a>&gt; <strong>executeQueryMessage</strong>(<a href="../mongo/MongoMessage.html">MongoMessage</a> queryMessage) <a class="anchor-link" href="#executeQueryMessage"
              title="Permalink to Db.executeQueryMessage">#</a></h4>
<div class="doc">

<pre class="source">
Future&lt;MongoReplyMessage&gt; executeQueryMessage(MongoMessage queryMessage){
  return connection.query(queryMessage);
}
</pre>
</div>
</div>
<div class="method"><h4 id="getLastError">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/Map.html">Map</a>&gt; <strong>getLastError</strong>() <a class="anchor-link" href="#getLastError"
              title="Permalink to Db.getLastError">#</a></h4>
<div class="doc">

<pre class="source">
Future&lt;Map&gt; getLastError(){    
  return executeDbCommand(DbCommand.createGetLastErrorCommand(this));
}
</pre>
</div>
</div>
<div class="method"><h4 id="getNonce">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/Map.html">Map</a>&gt; <strong>getNonce</strong>() <a class="anchor-link" href="#getNonce"
              title="Permalink to Db.getNonce">#</a></h4>
<div class="doc">

<pre class="source">
Future&lt;Map&gt; getNonce(){    
  return executeDbCommand(DbCommand.createGetNonceCommand(this));
}
</pre>
</div>
</div>
<div class="method"><h4 id="open">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/bool.html">bool</a>&gt; <strong>open</strong>() <a class="anchor-link" href="#open"
              title="Permalink to Db.open">#</a></h4>
<div class="doc">

<pre class="source">
Future&lt;bool&gt; open(){
  Completer completer = new Completer();
  initBsonPlatform();
  if (connection.connected){
    connection.close();
    connection = new Connection(serverConfig);
  }
  connection.connect().then((v) {
    if (serverConfig.userName === null) {
      completer.complete(v);
    }
    else {
      authenticate(serverConfig.userName,serverConfig.password).then((v) {
        completer.complete(v);
      });
    }
  });
  return completer.future;
}
</pre>
</div>
</div>
<div class="method"><h4 id="removeFromCollection">
<span class="show-code">Code</span>
<strong>removeFromCollection</strong>(<a href="http://api.dartlang.org/dart_core/String.html">String</a> collectionName, [<a href="http://api.dartlang.org/dart_core/Map.html">Map</a> selector = const{}]) <a class="anchor-link" href="#removeFromCollection"
              title="Permalink to Db.removeFromCollection">#</a></h4>
<div class="doc">

<pre class="source">
removeFromCollection(String collectionName, [Map selector = const {}]){
  connection.execute(new MongoRemoveMessage("$databaseName.$collectionName", selector));    
}
</pre>
</div>
</div>
<div class="method"><h4 id="validateDatabaseName">
<span class="show-code">Code</span>
<strong>validateDatabaseName</strong>(<a href="http://api.dartlang.org/dart_core/String.html">String</a> dbName) <a class="anchor-link" href="#validateDatabaseName"
              title="Permalink to Db.validateDatabaseName">#</a></h4>
<div class="doc">

<pre class="source">
validateDatabaseName(String dbName) {
  if(dbName.length === 0) throw "database name cannot be the empty string";  
  var invalidChars = [" ", ".", "\$", "/", "\\"];
  for(var i = 0; i &lt; invalidChars.length; i++) {
    if(dbName.indexOf(invalidChars[i]) != -1) throw new Exception("database names cannot contain the character '${invalidChars[i]}'");
  }
}
</pre>
</div>
</div>
<div class="method"><h4 id="wait">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/Map.html">Map</a>&gt; <strong>wait</strong>() <a class="anchor-link" href="#wait"
              title="Permalink to Db.wait">#</a></h4>
<div class="doc">

<pre class="source">
Future&lt;Map&gt; wait(){
  return getLastError();
}
</pre>
</div>
</div>
<h3>Fields</h3>
<div class="field"><h4 id="connection">
<span class="show-code">Code</span>
<a href="../mongo/Connection.html">Connection</a>         <strong>connection</strong> <a class="anchor-link"
            href="#connection"
            title="Permalink to Db.connection">#</a>
        </h4>
        <div class="doc">

<pre class="source">
Connection connection;
</pre>
</div>
</div>
<div class="field"><h4 id="databaseName">
<span class="show-code">Code</span>
<a href="http://api.dartlang.org/dart_core/String.html">String</a>         <strong>databaseName</strong> <a class="anchor-link"
            href="#databaseName"
            title="Permalink to Db.databaseName">#</a>
        </h4>
        <div class="doc">

<pre class="source">
String databaseName;
</pre>
</div>
</div>
<div class="field"><h4 id="serverConfig">
<span class="show-code">Code</span>
<a href="../mongo/ServerConfig.html">ServerConfig</a>         <strong>serverConfig</strong> <a class="anchor-link"
            href="#serverConfig"
            title="Permalink to Db.serverConfig">#</a>
        </h4>
        <div class="doc">

<pre class="source">
ServerConfig serverConfig;
</pre>
</div>
</div>
        </div>
        <div class="clear"></div>
        </div>
        
        <div class="footer">
          <div>This page was generated at 2012-09-12 16:03:43.241</div>
        </div>
        <script async src="../client-static.js"></script>
        </body></html>
        
